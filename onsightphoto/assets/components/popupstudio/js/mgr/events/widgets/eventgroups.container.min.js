Pop.container.EventGroups=function(e){e=e||{},Ext.applyIf(e,{id:"pop-cont-event-groups",defaults:{autoHeight:!0},items:[{layout:"form",items:[{xtype:"pop-combo-events",id:"event-groups-events-combo",fieldLabel:_("pop.event"),anchor:"95%",listeners:{select:{fn:this.loadTree,scope:this}}},{xtype:"pop-tree-event-groups",cls:"main-wrapper",id:"pop-tree-event-groups"}]}]}),Pop.container.EventGroups.superclass.constructor.call(this,e)},Ext.extend(Pop.container.EventGroups,Ext.Container,{loadTree:function(e,t){var o=Ext.getCmp("pop-tree-event-groups");o.getLoader().baseParams={event_id:t.id},o.setTitle(t.data.name),o.refresh()}}),Ext.reg("pop-cont-event-groups",Pop.container.EventGroups),Pop.tree.EventGroups=function(e){e=e||{},Ext.applyIf(e,{rootVisible:!1,enableDD:!0,header:!0,url:Pop.config.connectorUrl,action:"mgr/events/popEventGroupGetNodes",sortAction:"mgr/events/popEventGroupSortNodes",useDefaultToolbar:!0,ddAppendOnly:!1,stateful:!0,tbar:[],listeners:{load:function(e){0==e.attributes.active&&e.setCls("tree-inactive"),e.eachChild(function(e){0==e.attributes.active&&e.setCls("tree-inactive")})}}}),Pop.tree.EventGroups.superclass.constructor.call(this,e)},Ext.extend(Pop.tree.EventGroups,MODx.tree.Tree,{_showContextMenu:function(e,t){this.cm.activeNode=e;var o=e.getUI();this.cm.removeAll();var n=[];n.push({text:_("pop.create_event_group"),handler:this.createEventGroup},{text:_("pop.update_event_group"),handler:this.updateEventGroup},{text:_("pop.remove_event_group"),handler:this.removeEventGroup},"-"),o.hasClass("tree-inactive")?n.push({text:_("pop.activate"),handler:this.toggleActive}):n.push({text:_("pop.deactivate"),handler:this.toggleActive}),this.addContextMenuItem(n),this.cm.showAt(t.xy),t.stopEvent()},_handleDrop:function(e){var t=e.point,o=e.dropNode,n=e.target,r=n.parentNode;if("append"==t&&null!==n.findChild("name",o.attributes.name))return!1;var p=r.findChild("name",o.attributes.name);return null!==p?p.attributes.id==o.attributes.id?!0:!1:!0},_handleDrag:function(e){function t(e){for(var o={},n=e.childNodes,r=n.length,p=0;r>p;p++)o[n[p].id]=t(n[p]);return o}var o=Ext.encode(t(e.tree.root));this.fireEvent("beforeSort",o);var n=Ext.getCmp("event-groups-events-combo").getValue();MODx.Ajax.request({url:this.config.url,params:{event:n,target:e.target.attributes.id,source:e.source.dragData.node.attributes.id,point:e.point,data:encodeURIComponent(o),action:this.config.sortAction||"sort"},listeners:{success:{fn:function(t){var o=e.dropNode.getUI().getTextEl();o&&Ext.get(o).frame(),this.fireEvent("afterSort",{event:e,result:t})},scope:this},failure:{fn:function(e){return MODx.form.Handler.errorJSON(e),this.refresh(),!1},scope:this}}})},createEventGroup:function(e,t){var o={};this.cm.activeNode.attributes&&(o.event_id=this.cm.activeNode.attributes.event_id,o.parent=this.cm.activeNode.attributes.parent);var n=MODx.load({xtype:"pop-window-event-group-create",record:o,listeners:{success:{fn:function(){var e=this.cm.activeNode.attributes.parent?this.cm.activeNode.attributes.parent:"root";this.refreshNode(e,!0)},scope:this},hide:{fn:function(){this.destroy()}}}});n.show(t.target)},updateEventGroup:function(e,t){var o=this.cm.activeNode.attributes,n=MODx.load({xtype:"pop-window-event-group-update",record:o,listeners:{success:{fn:function(e){this.refresh()},scope:this},hide:{fn:function(){this.destroy()}}}});n.setValues(o),n.show(t.target)},removeEventGroup:function(e,t){var o=this.cm.activeNode.attributes.id;MODx.msg.confirm({title:_("pop.warning"),text:_("pop.event_group_conf_del"),url:Pop.config.connectorUrl,params:{action:"mgr/events/popEventGroupRemove",id:o},listeners:{success:{fn:function(){this.cm.activeNode.remove()},scope:this}}})},toggleActive:function(e,t){var o=this.cm.activeNode,n=o.attributes;Ext.Ajax.request({url:Pop.config.connectorUrl,params:{action:"mgr/events/popEventGroupUpdate",id:n.id,toggleActive:!0},success:function(e,t){var o=Ext.getCmp("pop-tree-event-groups");o.refresh()},failure:function(e,t){Ext.MessageBox.alert(_("pop.err"),e.status),console.log("Ajax server-side failure with status code "+e.status)}})}}),Ext.reg("pop-tree-event-groups",Pop.tree.EventGroups),Pop.window.CreateEventGroup=function(e){e=e||{},Ext.applyIf(e,{title:_("pop.create_event_group"),url:Pop.config.connectorUrl,action:"mgr/events/popEventGroupCreate",fields:[{xtype:"hidden",name:"event_id"},{xtype:"textfield",fieldLabel:_("pop.event_group"),name:"name",allowBlank:!1,anchor:"100%"},{fieldLabel:_("pop.parent"),name:"parent",hiddenName:"parent",id:"pop-create-event-group-combo-event-groups",xtype:"pop-combo-event-groups",anchor:"100%",listeners:{render:{fn:function(){var t=Ext.getCmp("pop-create-event-group-combo-event-groups");t.baseParams.event_id=e.record.event_id},scope:this}}},{fieldLabel:_("pop.order"),name:"rank",xtype:"numberfield",anchor:"100%"}]}),Pop.window.CreateEventGroup.superclass.constructor.call(this,e)},Ext.extend(Pop.window.CreateEventGroup,MODx.Window),Ext.reg("pop-window-event-group-create",Pop.window.CreateEventGroup),Pop.window.UpdateEventGroup=function(e){e=e||{},Ext.applyIf(e,{title:_("pop.update_event_group"),url:Pop.config.connectorUrl,action:"mgr/events/popEventGroupUpdate",fields:[{xtype:"hidden",name:"id"},{xtype:"hidden",name:"event_id"},{xtype:"textfield",fieldLabel:_("pop.event_group"),name:"name",allowBlank:!1,anchor:"100%"},{xtype:"xcheckbox",fieldLabel:_("pop.active"),name:"active",allowBlank:!1,anchor:"100%"},{fieldLabel:_("pop.parent"),name:"parent",hiddenName:"parent",id:"pop-update-event-group-combo-event-groups",xtype:"pop-combo-event-groups",anchor:"100%",listeners:{render:{fn:function(){var t=Ext.getCmp("pop-update-event-group-combo-event-groups");t.baseParams.event_id=e.record.event_id},scope:this}}},{fieldLabel:_("pop.order"),name:"rank",xtype:"numberfield",anchor:"100%",value:0}]}),Pop.window.UpdateEventGroup.superclass.constructor.call(this,e)},Ext.extend(Pop.window.UpdateEventGroup,MODx.Window),Ext.reg("pop-window-event-group-update",Pop.window.UpdateEventGroup);